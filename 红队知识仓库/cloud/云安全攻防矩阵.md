# 云安全攻防矩阵

## 〇、前置概念

Serverless：无服务器应用框架 Serverless Framework。

## 一、初始访问

### 0x01 云服务器攻击方式

#### 实例登录信息泄露

在购买并创建云服务器后，用户可以自行配置云服务器的登录用户名以及登录密码。

在Linux云服务器中，用户通过 SSH 的方式使用配置的用户名密码或 SSH 密钥的方式远程登录云服务器；在Windows服务器中，用户可以通过 RDP 文件或是远程桌面的形式登录云服务器。

当上述这些云服务器实例登录信息被窃取后，攻击者可以通过这些信息非法登录云服务器实例。

#### 账户劫持

当云厂商提供的控制台存在漏洞时，用户的账户存在一定的劫持风险。以 AWS 控制台更改历史记录功能模块处 XSS 漏洞以及 AWS 控制台实例 tag 处 XSS 为例，攻击者可以通过这些 XSS 漏洞完成账户劫持攻击，从而获取云服务器实例的控制权。

#### 网络钓鱼

为了获取云服务器的访问权限，攻击者可采用网络钓鱼技术手段完成此阶段攻击。攻击者通过向云服务器管理人员以及运维人员发送特定主题的钓鱼邮件、或是伪装身份与管理人员以及运维人员通过聊天工具进行交流，通过窃取凭据、登录信息或是安插后门的形式获取云服务器控制权。

#### 应用程序漏洞

当云服务器实例中运行的应用程序存在漏洞、或是由于配置不当导致这些应用可以被非法访问时，攻击者可以通过扫描探测的方式发现并利用这些应用程序漏洞进行攻击，从而获取云服务器实例的访问权限。

#### 使用恶意或存在漏洞的自定义镜像

云平台为用户提供公共镜像、自定义镜像等镜像服务以供用户快速创建和此镜像相同配置的云服务器实例。这里的镜像虽然与Docker镜像不同，其底层使用的是云硬盘快照服务，但云服务器镜像与  Docker 镜像一样存在着类似的风险，即恶意镜像以及存在漏洞的镜像风险。当用户使用其他用户共享的镜像创建云服务器实例时，云平台无法保证这个共享镜像的完整性或安全性。攻击者可以通过这个方式，制作恶意自定义镜像并通过共享的方式进行供应链攻击。

### 0x02 容器攻击方式

#### 应用程序漏洞

当容器中运行的应用程序存在漏洞，或是由于配置不当导致这些应用可以被非法访问时，攻击者可以通过扫描探测等方式发现并进行利用，从而获取容器的访问权限。

#### 使用恶意或存在漏洞的自定义镜像

攻击者构造恶意或存在漏洞的镜像，上传至镜像仓库。在目标服务器主动或被动形式下载恶意镜像并运行时，攻击者通过恶意容器进行初始访问。

#### 暴露 Kubernetes 控制面板

当用户开启 enable-skip-login 配置且错误的授权 Kubernetes-dashboard 过高权限后，攻击者可以直接访问 Kubernetes 控制面板并以此控制集群。

#### Kubeconfig 文件泄露

在一些攻击场景中，由于开发者不安全的开发以及配置，或者一些针对设备的入侵事件，导致 Kubeconfig 文件泄露，攻击者可以通过窃取到的 Kubeconfig 配置 kubectl 并访问集群。

#### Docker Engine API 公网暴露

Docker Engine API 是 Docker 提供的用于 Docker 客户端与 Docker 守护进程交互的 API，如果配置开启 Tcp Socket，则会存在未一定的风险风险。攻击者可以利用公网暴露的 Docker Engine API 在远程主机上创建一个特权容器并挂载主机根目录进行后续攻击流程。

#### Kube Apiserver insecure-port 开启

非安全端口提供 HTTP 服务且无需身份认证，默认开放在 8080 端口。此端口上开放的服务应该是用于测试，如果其在生产环境中被暴露出来，可以控制多数 K8s 总控组件，并获取多数容器交互式 Shell。

#### Kube Apiserver secure-port 开启匿名访问

安全端口提供 HTTPS 服务且支持身份认证，默认开放在 6443 端口。错误配置将会导致匿名访问。攻击者可以匿名访问 Kube API Server，并在 Pod 中执行命令。

#### Kubelet API 匿名访问

Kubelet 用于在 Node上管理本机 Pod，如果 kubelet 存在匿名访问漏洞，攻击者可以通过 Kubelet API 10250 端口在 Node 中任意容器里执行命令。

#### Etcd 2379 端口公网暴露

Kubernetes 使用 Etcd v3 存储数据，默认监听 2379 端口，如果 Etcd 2379 暴露到公网且存在未授权访问漏洞，将导致敏感信息泄露，攻击者可以通过收集到的凭据接管集群。

#### Kubectl proxy 公网访问

Kubectl proxy 命令以反向代理的模式运行 Kubectl，建立代理后用户可以使用 curl、wget 或浏览器访问 Kube Apiserver 。Kubectl proxy 公网访问，其危害与利用方式与 Kube Apiserver 一致。

### 0x03 COS存储攻击方式

#### 对象存储SDK泄露

云平台所提供的对象存储服务，除了拥有多种 API 接口外，还提供了丰富多样的 SDK 供开发者使用。在 SDK 初始化阶段，开发者需要在 SDK 中配置存储桶名称、路径、地域等基本信息，并且需要配置云平台的永久密钥或临时密钥，这些信息将会被编写在 SDK 代码中以供应用程序操作存储桶。

但是，如果这些承载着密钥的代码片段不慎泄露，比如开发者误将源码上传至公开仓库或者应用开发商在为客户提供的演示示例中未对自身 SDK中 凭据信息进行删除，这些场景将会导致对象存储凭据泄露，进而导致对象存储服务遭受入侵，攻击者通过冒用凭据所有者身份攻击对象存储服务。

#### 存储桶工具配置文件泄露

在对象存储服务使用过程中，为了方便用户操作存储桶，官方以及开源社区提供了大量的对象存储客户端工具以供用户使用，在使用这些工具时，首先需要在工具的配置文件或配置项中填写存储服务相关信息以及用户凭据，以便工具与存储服务之间的交互。

在某些攻击场景下，例如开发者个人 PC 遭受钓鱼攻击、开发者对象存储客户端工具配置文件泄露等，这些编写在存储服务工具配置文件中的凭据以及存储桶信息将会被泄露出来，攻击者可以通过分析这些配置文件，从中获取凭据，而在这些工具中配置的，往往又是用户的云平台主 API 密钥，攻击者通过这些信息可以控制对象存储服务，在一些严重的场景，攻击者甚至可以控制用户的所有云上资产。

#### 前端直传功能获取凭据

在一些对象存储服务与 Web 开发以及移动开发相结合的场景中，开发者选择使用前端直传功能来操作对象存储服务，前端直传功能指的是利用 iOS/Android/JavaScript 等 SDK 通过前端直接向访问对象存储服务。

前端直传功能，可以很好的节约后端服务器的带宽与负载，但为了实现此功能，需要开发者将凭据编写在前端代码中，虽然凭据存放于前端代码中，可以被攻击者轻易获取，但这并不代表此功能不安全，在使用此功能时，只要遵守安全的开发规范，则可以保证对象存储服务的安全：正确的做法是使用临时密钥而非永久密钥作为前端凭据，并且在生成临时密钥时按照最小权限原则进行配置。

但是实际应用中，如果开发人员并未遵循安全开发原则，例如错误的使用了永久密钥，或为临时凭据配置了错误的权限，这将导致攻击者可以通过前端获取的凭据访问对象存储服务。攻击者通过分析前端代码，或者通过抓取流量的方式，获得这些错误配置生成的凭据，并以此发起攻击。

### 0x04 Serverless攻击方式

#### serverless service爆破

若 serverless service 仅使用简单的英文字母或单词作为命名，则攻击者可以通过字典枚举爆破 serverless service 服务名称来找到潜在目标。

#### serverless.yml泄漏

通过信息泄漏查找潜在的 serverless service，如通过 GitHub 搜索 serverless.yml 关键字来发现潜在 serverless 目标。

#### 应用程序漏洞

利用应用程序本身存在的安全漏洞攻击 serverless service，若应用程序未对外部传入的参数进行严格过滤则可能导致注入风险。

#### 组件漏洞/使用易受攻击的库

当选择编程语言开发功能时，必须保证导入的库以及代码本身是安全的。使用含有已知漏洞的组件是 Web 应用程序 10 大威胁之一。若应用程序使用了存在漏洞的第三方组件，则 serverless 服务也将会受到漏洞威胁。

### 0x05 共同攻击方式

#### 实例元数据服务未授权访问

云服务器实例元数据服务是一种提供查询运行中的实例内元数据的服务，云服务器实例元数据服务运行在链路本地地址上，当实例向元数据服务发起请求时，该请求不会通过网络传输，但是如果云服务器上的应用存在 RCE、SSRF 等漏洞时，攻击者可以通过漏洞访问实例元数据服务。

通过云服务器实例元数据服务查询，攻击者除了可以获取云服务器实例的一些属性之外，更重要的是可以获取与实例绑定的拥有操作云服务的角色，并通过此角色获取云服务的控制权。

#### 云平台账号非法登录

云平台提供多种身份验证机制以供用户登录，包括手机验证、账号密码验证、邮箱验证等。在云平台登录环节，攻击者通过多种手法进行攻击以获取用户的登录权限，并冒用用户身份非法登录，具体的技术包括使用弱口令、使用用户泄露账号数据、骗取用户登录手机验证码、盗取用户登录账号等。攻击者使用获取到的账号信息进行非法登录云平台后，即可操作云服务。

#### 云平台主API密钥泄露

云平台主 API 密钥重要性等同于用户的登录密码，其代表了账号所有者的身份以及对应的权限。

API 密钥由 SecretId 和 SecretKey 组成，用户可以通过 API 密钥来访问云平台 API 进而管理账号下的资源。在一些攻击场景中，由于开发者不安全的开发以及配置，或者一些针对设备的入侵事件，导致云平台主 API 密钥泄露，攻击者可以通过窃取到的云平台主 API 密钥，冒用账号所有者的身份入侵云平台，非法操作云服务。

## 二、执行

### 0x01 云服务器攻击方式

#### 通过控制台登录实例执行

攻击者在初始访问阶段获取到平台登录凭据后，可以利用平台凭据登录云平台，并直接使用云平台提供的 Web 控制台登录云服务器实例，在成功登录实例后，攻击者可以在实例内部执行命令。

#### 写入userdata执行命令

Userdata 是云服务器为用户提供的一项自定义数据服务，在创建云服务器时，用户可以通过指定自定义数据，进行配置实例。当云服务器启动时，自定义数据将以文本的方式传递到云服务器中，并执行该文本。通过这一功能，攻击者可以修改实例 userdata 并向其中写入待执行的命令，这些代码将会在实例每次启动时自动执行。攻击者可以通过重启云服务器实例的方式，加载 userdata 中命令并执行。

#### 利用后门文件执行指令

攻击者在云服务器实例中部署后门文件的方式有多种，例如通过Web应用漏洞向云服务器实例上传后门文件、或是通过供应链攻击的方式诱使目标使用存在后门的恶意镜像，当后门文件部署成功后，攻击者可以利用这些后门文件在云服务器实例上执行命令。

#### 利用应用程序执行

云服务器实例上部署的应用程序，可能会直接或者间接的提供命令执行功能，例如一些服务器管理类应用程序将直接提供在云服务器上执行命令的功能，而另一些应用，例如数据库服务，可以利用一些组件进行命令执行。当这些程序存在配置错误时，攻击者可以直接利用这些应用程序在云服务器实例上执行命令。

#### 利用SSH服务进入实例执行

云服务器 Linux 实例上往往运行着 SSH 服务，当攻击者在初始访问阶段成功获取到有效的登录凭据后，即可通过 SSH 登录云服务器实例并进行命令执行。

#### 利用远程代码执行漏洞执行

当云服务器上部署的应用程序存在远程代码执行漏洞时，攻击者将利用此脆弱的应用程序并通过编写相应的 EXP 来进行远程命令执行。

### 0x02 容器攻击方式

#### 部署后门容器

攻击者在目标主机上启动存在恶意代码的镜像，通过反弹 Shell 等方式进入容器执行，或在启动容器时将宿主机的根目录挂载到容器内部目录中，除此之外，攻击者也可以通过特权容器的形式启动容器，以此部署后门容器。

#### 进入容器执行

攻击者可以利用不同工具或方式在容器中执行命令，例如使用 Kubectl 工具与 Kube apiserver 进行交互、通过 Kubeletctl 工具与 Kubelet api 交互的方式等。攻击者通过这些方式，在容器内部执行恶意命令。

#### 利用SSH服务登入

在一些场景中，用户会在容器中安装并使用 SSH 服务，攻击者可以通过使用窃取到的登录凭证，或使用暴力破解的方式，进入到容器中，从而获取执行恶意操作的能力。

#### 利用远程代码执行漏洞执行

攻击者通过容器中存在远程代码执行漏洞的应用程序，获取容器中执行命令的能力。

#### 利用Kube Apiserver 执行

Kube-apiserver 是 Kubernetes 最重要的核心组件之一，提供集群管理的 REST API 接口以及其他模块之间的数据交互和通信。当获到 Kube Apiserver 控制权后，可以通过访问 Kube API Server，在Pod 中构建命令通道并使用交互式执行下发指令。

#### 利用Kubelet API执行

攻击者可以通过 Kubelet API 10250 端口发送请求以获取此节点中 Pod 信息，然后选取 Pod 并在 Pod 内执行命令。

### 0x03 COS存储攻击方式

（NULL）

### 0x04 Serverless攻击方式

#### 构造恶意代码获取shell权限登入

攻击者通过构造恶意项目并上传到 serverless 服务端进行构建并运行其中的恶意代码，从而达到获取 serverless 服务器 Shell 权限的目的。

#### 利用漏洞获取shell权限登入

若开发人员编写的项目代码中存在漏洞，如未对外部传入的参数进行过滤或过滤不严格，从而导致攻击者利用事件注入漏洞获取 serverless 应用服务器权限。

#### 利用远程代码执行漏洞执行

若开发人员在代码中调用 Shell 时，对命令行中的特殊字符（比如|、&、；等）未进行转义，则恶意用户可以直接控制 eval、system、exec、shell_exec 等函数的参数从而导致执行其他非法命令。

#### 利用SQL/XSS漏洞注入命令

若开发人员在开发程序时未对用户输入进行严格过滤，如sql查询语句中使用 sql 语句拼接，nodejs 项目中存在 xss 且未限制 child_process 模块下 exec/execSync 等方法，则可能导致 xss 升级为 rce。

#### 利用存在漏洞的组件/软件包执行

利用组件漏洞进行漏洞攻击，通常无服务器功能是一小段代码，用于执行单个离散任务，通常无服务器要执行该任务将需要依赖第三方软件包和开源库，以及通过应用程序编程接口（API）调用使用第三方远程 Web 服务，如编写项目中使用了存在漏洞的第三方组件，则 serverless 服务可能受到漏洞影响。

#### 利用未及时删除的函数执行

使用无服务器的好处之一是我们无需为不使用的功能付费，一般情况下我们也不需要删除未使用的功能，因为这将不会产生费用。然而这些函数仍然作为攻击面存在，甚至比活跃使用的函数更重要，因为它们不太可能被更新和修补。随着时间的推移，这些未使用的功能可能成为攻击者利用具有已知漏洞的组件的目标。

#### 使用云API执行命令

在创建 API Getway 终端节点时，默认配置不包括使用任何类型的身份验证或安全密钥，这可能导致恶意使用或滥用 API。

例如：AWS 为 Amazon API Gateway 用户创建了安全功能，以便在开发和实施其安全策略时加以利用。尽管如此，用户仍然可能不安全的公开 Amazon API Gateway 端点。造成这种情况的一个原因是用户通常依赖默认的安全策略。开放且暴露的 API Gateway 终端节点可能被滥用为入口点来破坏其背后的服务受损。

#### 使用云厂商工具执行

使用云厂商提供的工具执行命令，如 aws 的 aws cli 工具。例如凭证通常作为变量存储在 AWS Lambda 基础设施中，如果恶意攻击者利用函数并上传 aws cli 工具，aws cli 工具可以使用保存的凭证来管理 AWS Lambda 和其它 AWS 服务。

#### 文件驻留导致命令执行

有些 Serverless 实现在应用程序生命周期结束之后，程序文件并未及时清理。一方面开发者希望借助容器 “对 Linux Cgroup 和 Namespace 进行管理的特性” 用于实现限制应用的资源访问能力和进程权限的需求；其次开发者希望能更快的达到用户文件清理的目的，避免反复初始化容器环境带来的时间和资源上的消耗，从而复用同一个容器环境。

### 0x05 共同攻击方式

#### 使用云API执行命令

攻击者利用初始访问阶段获取到相应凭据后，可以通过向云平台 API 接口发送 HTTP/HTTPS 请求，以实现与云服务的交互操作。云平台提供了丰富的 API 接口以供用户使用，攻击者可以通过使用这些 API 接口并构造相应的参数，以此执行对应的云服务操作指令。

#### 使用云厂商工具执行

除了使用云 API 接口完成对云服务的执行命令操作之外，还可以选择使用工具来化简通过 API 接口使用云服务的操作。在配置完成相关信息以及凭据后，攻击者可以使用工具执行服务相应的操作名：通过执行简单的命令行指令来完成操作。

## 三、持久化

### 0x01 云服务器攻击方式

#### 利用远程控制软件

为了方便管理云服务器实例，管理员有可能在实例中安装有远程控制软件，这种情况在 windows 实例中居多。攻击者可以在服务器中搜索此类远程控制软件，并获取连接凭据，进行持久化。攻击者也可以在实例中安装远控软件以达成持久化的目的。

#### 在userdata中添加后门

正如“执行”阶段所介绍，攻击者可以利用云服务器提供的 userdata 服务进行持久化操作，攻击者可以通过调用云 API 接口的方式在 userdata 中写入后门代码，每当服务器重启时，后门代码将会自动执行，从而实现了隐蔽的持久化操作目的。

这些场景中，攻击者可以在存储桶中存储的 Web 应用代码内安插后门代码或后门文件，并触发代码自动化部署服务将后门部署至服务器以完成持久化操作。这些存储着恶意后门将会持久的存在于 Web 应用代码中，当服务器代码迁移时，这些后门也将随着迁移到新的服务器上部署。

#### 在自定义镜像库中导入后门镜像

在攻击者获取云服务器控制台权限后，可以对用户自定义镜像仓库中的镜像进行导入、删除等操作，攻击者可以将其构造的存在后门的镜像上传至用户镜像仓库。此外，为了提高攻击成功率，攻击者还可以使用后门镜像替换用户镜像仓库中原有镜像。当用户使用后门镜像进行实例创建时，即可触发恶意代码以完成持久化操作。

#### 给现有的用户分配额外的密钥

API 密钥是构建腾讯云 API 请求的重要凭证，云平台运行用户创建多个 API 密钥，通过此功能，拥有 API 密钥管理权限的攻击者可以为账户下所有用户分配一个额外的 API 密钥，并使用这些 API 密钥进行攻击。

#### 建立辅助账号登录

拥有访问管理权限的攻击者可以通过建立子账号的形式进行持久化操作，攻击者可以将建立的子账号关联等同于主账号的策略，并通过子账号进行后续的攻击行为。

#### 在云函数中添加后门

云函数是是一种计算服务，可以为企业和开发者们提供的无服务器执行环境。用户只需使用平台支持的语言编写核心代码并设置代码运行的条件，即可弹性、安全地运行代码，由平台完成服务器和操作系统维护、容量配置和自动扩展、代码监控和日志记录等工作。

以 AWS Lambda 为例，用户可以创建一个 IAM 角色并赋予其相应的权限并在创建函数时提供该角色作为此函数的执行角色，当函数被调用时，Lambda 代入该角色，如果函数绑定的角色权限过高，攻击者可以在其中插入后门代码，例如在调用该函数后创建一个新用户，以此进行持久化操作。

### 0x02 容器攻击方式

#### 通过容器逃逸向宿主机写入文件

在错误挂载宿主机目录或是特权容器这类场景下，攻击者可以通过修改敏感文件、或是在宿主机中写入文件的方式进行持久化，例如在宿主机中写入攻击者自己的公钥以用来登录宿主机并持久控制宿主机。

#### 在自定义镜像库中镜像植入后门

多数云厂商提供自定义镜像仓库服务，拥有目标账号私有镜像仓库控制权限的攻击者，可以通过使用恶意镜像替换仓库中现有镜像的形式，向镜像中植入后门，并以此进行持久化操作。

#### Kubernetes定时任务

Linux 通过 Cron 程序提供定时执行任务的功能，Kubernetes 的 CronJob 也提供了类似的功能进行定时、周期性、重复性任务执行。攻击者可以通过利用 CronJob 功能生成一个 Job，通过此 Job 实现持久化。

#### 在容器内植入后门

攻击者在获取容器初始访问权限后，通过在容器内植入后门的方式，进行针对容器的攻击持久化攻击操作。

### 0x03 COS存储攻击方式

#### 在存储对象中植入后门

针对对象存储服务的持久化攻击阶段，主要依赖于业务中采用的代码自动化部署服务将植入后门的代码自动部署完成。

在一些云上场景中，开发者使用云托管业务来管理其 Web 应用，云托管服务将使用者的业务代码存储于特定的存储桶中，并采用代码自动化部署服务在代码每次发生变更时都进行构建、测试和部署操作。

在这些场景中，攻击者可以在存储桶中存储的 Web 应用代码内安插后门代码或后门文件，并触发代码自动化部署服务将后门部署至服务器以完成持久化操作。这些存储着恶意后门将会持久的存在于 Web 应用代码中，当服务器代码迁移时，这些后门也将随着迁移到新的服务器上部署。

### 0x04 Serverless攻击方式

#### 利用供应链攻击

严重的漏洞可以从开源库和框架中继承，nodejs 生态系统的一项统计表明我们部署的 97% 的代码来自于开源库和开源组件，所以供应链攻击也是 serverless 一项重要的安全风险。

#### 在可写权限目录中插入后门

通常 /tmp 目录是用户可以在 Lambda 函数调用时写入磁盘的唯一位置，写入 /tmp 的文件可以具有执行权限，这意味着如果恶意攻击者成功利用了错误代码，他们可以将他们的工具和脚本保存在此文件夹中并且执行它们。保持连接和优化缓存对应用使用友好，但它确实打破了 Lambda 的沙盒概念。

案例：通过在 AWS Lambda 控制台中修改配置，在 AWS Lambda 函数内的 /tmp 文件夹中写入的大文件，该函数持续了 12 分钟。可以通过这种方式持久化控制 serverless 服务器。

#### 替换引导程序

当攻击者获得了 serverless 服务器 shell，则可以通过执行利用脚本替换运行时，从而实现接管 serverless 实例实现持久化控制。

#### 利用热启动特性持久化

无服务器函数具有关联的配置信息（名称、描述、条目和资源要求），并且是短暂的，它们只有几秒钟或者几分钟的生命周期。它们还被设计为无状态的，允许快速启动尽可能多的函数副本以适应传入事件的速率。每次函数调用都会创建一个新的函数实例。第一次调用函数时，被称为“冷启动”。

为了避免延迟，函数需要保持缓存，也称为“热启动”，其中相同的功能沙箱或不同调用的容器被重用。恶意攻击者通过定期发送请求以防止实例被删除来达到持久化的目的。

#### 更改acl修改函数超时时间

使用 aws cli 工具结合泄漏的临时凭据，可以查看和修改 IAM 策略来更改 AWS Lambda 函数超时时间，从而达到持久化目的。

#### 攻击公用容器/镜像

在不同的 Serverless 架构中，都有多类持久化且公用的容器以实现程序调度、代码预编译、代码下载运行等逻辑。这类容器一般拥有获取所有用户代码、配置和环境变量的能力，同时也比较容易出现 Docker IN Docker 或大权限 Service Account 的设计。

## 四、权限提升

### 0x01 云服务器攻击方式

#### 通过访问管理提权

错误的授予云平台子账号过高的权限，也可能会导致子账号通过访问管理功能进行提权操作。由于错误的授予云平台子账号过高的操作访问管理功能的权限，子账号用户可以通过访问管理功能自行授权策略。通过此攻击手段，攻击者可以通过在访问管理中修改其云服务器的权限策略，以达到权限提升。

#### 利用应用程序提权

攻击者通过云服务器中运行的 Docker 容器中应用漏洞，成功获取 Docker 容器的权限，攻击者可以通过 Docker 漏洞或错误配置进行容器逃逸，并获取云主机的控制权，从而实现权限提升。当然，攻击者也可以通过其他应用程序进行提权。

#### 创建高权限角色

当攻击者拥有访问管理中新建角色的权限时，可以通过调用云 API 接口的方式，建立一个新的角色，并为这个角色赋予高权限的策略，攻击者可以通过利用此角色进行后续的攻击行为。

#### 利用操作系统漏洞进行提权

与传统主机安全问题相似，云服务器实例也同样可能存在操作系统漏洞，攻击者可以利用操作系统漏洞，进行权限提升。

### 0x02 容器攻击方式

#### 利用特权容器提权

使用特权模式启动容器，将赋予容器很高的权限。攻击者可以通过特权容器访问宿主机磁盘设备、修改 AppArmor 或 SELinux 的配置，以达到容器逃逸目的。

#### 利用错误配置提权

攻击者可以利用容器内错误配置进行权限提升，常见的错误配置有：容器内可访问 Docker.sock、挂载 Cgroup 目录、错误配置 Lxcfs Cgroup 以及挂载宿主机敏感文件等。攻击者可以利用这些错误配置进行权限提升操作。

#### 利用操作系统漏洞提权

由于容器与宿主共享内核，并且使用内核功能（例如 Cgroups 和 namespaces）使容器内资源与宿主机隔离。攻击者可以使用 Linux 操作系统内核漏洞进行容器逃逸。

#### 利用 Kubernetes 漏洞进行提权

攻击者可以使用 Kubernetes 漏洞进行权限提升或是容器逃逸。

#### 利用 Docker 漏洞提权

攻击者可以利用 Docker 引擎自身的漏洞进行权限提升或容器逃逸。当目标服务器上的 Docker 引擎版本未即使升级，则存在此攻击风险。

#### 创建高权限用户

Kubernetes 使用基于角色的访问控制（RBAC）来进行操作鉴权，如果攻击者获取的用户拥有 RoleBinding 操作权限，可以创建高权限用户的方式进行权限提升。

### 0x03 COS存储攻击方式

#### 通过Write Acl提权

对象存储服务访问控制列表（ACL）是与资源关联的一个指定被授权者和授予权限的列表，每个存储桶和对象都有与之关联的 ACL。

如果错误的授权给一个子用户操作存储桶 ACL 以及对象 ACL 的权限，即使该用户并未被赋予读取存储桶、写入存储桶、读取对象、写入对象的权限，这并不表示此用户不可以执行上述操作，该用户可以通过修改存储桶以及对象的 ACL，将目标对象设置为任意读取权限，从而获取了存储桶以及存储对象的操作权限。因此，赋予子用户操作存储桶 ACL 以及对象 ACL 的权限，这个行为是及其危险的。

#### 通过访问管理提权

错误的授予云平台子账号过高的权限，也可能会导致子账号通过访问管理功能进行提权操作。与通过Write Acl 提权操作不同的是，由于错误的授予云平台子账号过高的操作访问管理功能的权限，子账号用户可以通过访问管理功能自行授权策略，例如授权 QcloudCOSFullAccess 策略，此策略授予子账号用户对象存储服务全读写访问权限，而非单纯的修改存储桶以及存储对象的 ACL。

通过此攻击手段，拥有操作对象存储服务权限的子账号，即使子账号自身对目标存储桶、存储对象无可读可写权限，子账号可以通过在访问管理中修改其对象存储服务的权限策略，越权操作存储桶中资源。

### 0x04 Serverless攻击方式

#### IAM 特权升级

通过查找用户账户中存在的 IAM 配置错误进行权限提升，这将允许攻击者从受损的低权限帐户升级到完全管理权限。如配置不当的角色权限可能允许恶意用户创建一个新的策略版本，这将允许更改策略中的权限。如果没有安全的设置角色权限，恶意用户可以被授予完全管理员权限。

## 五、防御绕过

### 0x01 云服务器攻击方式

#### 关闭安全监控服务

云平台为了保护用户云主机的安全，往往会提供一些安全监控产品用以监控和验证活动事件的真实性，并且以此辨识安全事件，检测未经授权的访问。

攻击者可以通过在攻击流程中关闭安全监控产品以进行防御绕，但是进行此操作会在控制台中触发告警，也可以通过配置禁用多区域日志记录功能，并在监控区域外进行攻击。

#### 监控区域外进行攻击

云平台提供的安全监控服务，默认情况下是进行全区域安全监控，但是在一些场景中可能出现一些监控盲区，例如用户在使用安全监控服务时，关闭了全区域监控，仅开启部分区域的监控。

#### 禁用日志记录

与直接关闭安全监控服务相比，攻击者可以通过禁用平台监控告警日志的方式进行防御绕过，并在攻击流程结束后再次开启告警日志。

#### 日志清理

攻击者在完成攻击流程后，可以删除监控服务日志以及云主机上的日志，以防攻击行为暴露。

### 0x02 容器攻击方式

#### 关闭容器安全产品

云厂商往往提供容器安全服务以供容器资产管理、镜像安全、运行时入侵检测等安全服务。这些安全产品将会从容器镜像生成、存储到运行时的全生命周期进行保护，如果攻击者拥有容器安全产品权限，可以通过关闭安全产品的方式进行防御绕过。

#### 常规Pod中植入后门

在云厂商提供的容器编排服务中，会默认启动一些 Pod 用以提供基础功能用以日志收集、性能分析等操作。攻击者可以在这些常规 Pod 中植入后门代码，以此进行持久化操作。

#### 日志清理

攻击者在完成攻击流程后，可以通过删除容器内以及宿主机中的日志、删除监控服务日志或卸载安全产品 Agent 的方式进行防御绕过。

### 0x03 COS存储攻击方式

（NULL）

### 0x04 Serverless攻击方式

#### 更改和操纵函数执行流

如果可以更改和操纵函数执行流，则可能绕过应用程序安全控制，多个函数的调用过程可能成为攻击者的攻击目标。

#### 日志清理

通过清理日志达到绕过防御的目的。

### 0x05 共同攻击方式

#### 通过代理访问

大多数云产品提供操作日志记录功能，将记录时间、操作内容等。攻击者可以利用代理服务器来隐藏他们源IP。

## 六、窃取凭据

### 0x01 云服务器攻击方式

#### 获取服务器实例登录账号

当攻击者获取云服务器实例的控制权后，可以通过一些方式获取服务器上用户的登录凭据，例如使用 mimikatz 抓取 Windows 凭证，并将获取到的这些登录凭据应用到后续的攻击流程中。

#### 元数据服务获取角色临时凭据

云服务器为用户提供了一种每名实例元数据的服务，元数据即表示实例的相关数据，可以用来配置或管理正在运行的实例。用户可以通过元数据服务在运行中的实例内查看实例的元数据。

### 0x02 容器攻击方式

#### 获取Kubernetes Kubeconfig

Kubernetes 使用 Kubeconfig 文件来组织有关集群、用户、命名空间和身份认证机制的信息。Kubeconfig 默认在存储于 $HOME/.kube 目录中，攻击者将会尝试在节点的此目录中查找Kubeconfig 以窃取这个文件。

### 0x03 COS存储攻击方式

（NULL）

### 0x04 Serverless攻击方式

#### 元数据服务获取角色临时凭据

当已经通过漏洞或上传恶意项目获得了 serverless 服务器 Shell 时，可以通过访问元数据服务来获取角色临时凭据，若目标可以访问到元数据且将临时凭据存储在了元数据中，则可以通过这种方式窃取角色临时凭据。

### 0x05 共同攻击方式

#### 用户敏感数据泄露

在一些场景中，开发者使用云产品存储其业务中的用户数据，例如用户的姓名、身份证号码、电话等敏感数据，当然也会包含用户账号密码等凭据信息。攻击者通过对云产品中用户数据的提取与分析以窃取这些用户的凭据数据，并通过获取的信息进行后续的攻击。

#### 应用凭证泄露

云产品中的配置文件中可能存储着一些敏感信息，例如一些应用的访问凭据或是登录密码，攻击者可以在云服务器中查找这些配置文件，并将其中的敏感数据进行窃取并在后续的攻击中加以利用。

#### 云服务凭证泄露

在一些场景中，用户的 Web 应用程序源码将会存储于云服务中，并且默认以明文形式存储，在泄露的 Web 应用程序源码中，往往存在着 Web 应用开发者用来调用其他云上服务的凭据，甚至存在云平台主 API 密钥，攻击者可以通过分析泄露的 Web 应用程序源码来获取这些凭据。

## 七、探测

### 0x01 云服务器攻击方式

#### 云资产探测

攻击者在探测阶段，会寻找环境中一切可用的资源，例如实例、存储以及数据库服务等。通常攻击者可以使用云平台提供的 API 或工具来完成云资产探测，通过发出命令等方法来搜集基础设施的信息。

以 AWS API 接口为例，可以使用 DescribeInstances 接口来查询账户中一个或多个实例的信息，或是使用 ListBuckets API 接口来查询目标存储桶列表信息。

#### 网络扫描

与传统的内网扫描类似，攻击者在此阶段也会尝试发现在其他云主机上运行的服务，攻击者使用系统自带的或上传至云服务实例的工具进行端口扫描和漏洞扫描以发现那些容易受到远程攻击的服务。此外，如果目标云环境与非云环境连通，攻击者也可能能够识别在非云系统上运行的服务。

### 0x02 容器攻击方式

#### 探测Kubernetes Dashboard

Kubernetes Dashboard 是基于网页的 Kubernetes 用户界面。用户可以使用 Dashboard 获取运行在集群中的应用的概览信息，也可以创建或者修改 Kubernetes 资源 （如 Deployment，Job，DaemonSet 等等）。

攻击者可以通过网络扫描的方式，探测 Dashboard 所在 service 地址。

#### 探测 Kubernetes APIServer

Kube APIServer 默认开放在 6443 端口或 8080 端口，使用高权限 service account 可以通过 Kube APIServer 执行命令；使用低权限 service account 也可以进行信息收集。

#### 网络扫描

同传统的渗透测试相似，在集群探测阶段，可以对 Node、Pod 以及 Service 所在的网段进行主机存活探测以及端口探测，并通过扫描的结果进行后续渗透。

#### 探测Kubelet API

Kubelet 部署于集群中所有 Node 中，用以在 Node上管理本机 Pod 以及容器，攻击者可以通过扫描Kubelet API 10250 端口的方式，探测开放的 Kubelet API。

#### 探测Kubelet ReadOnly API

Kubelet Readonly API 端口为只读端口，默认开放在 10255 端口，访问该端口不需要认证和鉴权，可以获取 pod、node 信息。攻击者可以通过扫描 10255 端口的方式探测此端口，并从中获取敏感信息。

#### 探测Etcd服务

Kubernetes 使用 etcd v3 存储数据，默认监听 2379 端口。通过 Etcd 服务，攻击者可以获取用以认证访问 Kube Apiserver 的凭据。

### 0x03 COS存储攻击方式

（NULL）

### 0x04 Serverless攻击方式

#### 内外网扫描

serverless 服务被恶意利用进行扫描，如通过 serverless 应用进行端口探测、目录扫描、C2 服务等，将 serverless 基础设施作为攻击媒介来攻击其它系统。

## 八、横向移动

### 0x01 云服务器攻击方式

#### 使用实例账号爆破

当攻击者在窃取凭据阶段，在实例中成功获取了有效的账号信息后，攻击者可以利用这些账号数据制作账号字典并尝试爆破目标的云资产或非云资产，并横向移动到这些资产中。

#### 窃取角色临时凭据横向访问

攻击者通过实例元数据服务，可以获取与实例绑定的角色的临时凭据，攻击者可以利用获取的角色临时凭据，横向移动到角色权限范围内的云资产中。

### 0x02 容器攻击方式

#### 通过容器逃逸进入宿主机

攻击者可以通过错误配置以及漏洞利用，从容器内横向移动到宿主机上。

#### 通过K8s Dashboard横向移动

在探测到 K8s Dashboard 并成功获取访问权限后，攻击者可以使用控制台进行资源管理，并进行横向移动。

### 0x03 COS存储攻击方式

（NULL）

### 0x04 Serverless攻击方式

#### 横向移动到其他函数应用

当创建 IAM 策略时，没有遵循最小权限原则，对函数分配的角色将决定该函数在执行时将拥有的权限。

由于分配给函数的 IAM 角色过于宽松，攻击者可能会利用函数中的应用程序层漏洞执行横向移动到当前云账户中的其它资源。

#### 窃取角色临时凭据访问云服务

当攻击者获取到 serverless 服务器 Shell 后，在环境变量或元数据服务中获取到临时凭据，则可以利用泄漏的临时凭据访问其它云服务应用和资源。

#### IAM策略未使用Lambda进行版本控制

用户可以对函数的代码和配置进行版本控制，当 IAM 策略未使用 Lambda 进行版本控制，则可能导致 IAM 策略不生效，从而导致 IAM 配置错误导致权限过大横向移动访问到其它资源。

### 0x05 共同攻击方式

#### 窃取凭据访问云服务

通过存储桶中 Web 应用程序源代码的分析，攻击者可能会从 Web 应用程序的配置文件中获取的应用开发者用来调用其他云上服务的凭据。

攻击者利用获取到的云凭据，横向移动到用户的其他云上业务中。如果攻击者获取到的凭据为云平台主 API 密钥，攻击者可以通过此密钥横向移动到用户的所有云上资产中。

#### 窃取用户账号攻击其他应用

在一些场景中，用户的 Web 应用程序源码将会存储于云服务中，并且默认以明文形式存储，在泄露的 Web 应用程序源码中，往往存在着 Web 应用开发者用来调用其他云上服务的凭据，甚至存在云平台主 API 密钥，攻击者可以通过分析泄露的 Web 应用程序源码来获取这些凭据。

## 九、影响

### 0x01 数据窃取

攻击者将会窃取用户的敏感数据，这些信息可能包含用户的个人隐私信息、账号凭据或是企业敏感信息以及数据。当用户敏感信息泄露事件发生后，将会造成严重的影响。

### 0x02 数据破坏

攻击者将会对目标资源上的文件以及数据信息进行删除或者覆盖操作，以达到破坏数据的目的。

### 0x03 资源劫持

攻击者将会劫持与滥用目标资源来进行一些恶意目的，例如劫持受损害的资源进行挖矿操作从而进行获利，或是滥用目标资源用以进行网络攻击行为。

### 0x04 拒绝服务

攻击者将会对目标服务进行拒绝服务攻击，使得合法用户无法正常使用服务与资源。

### 0x05 加密勒索

攻击者将会尝试寻找目标资源中核心的文件、数据以及代码，并对这些资源进行加密处理，进而勒索目标用户。